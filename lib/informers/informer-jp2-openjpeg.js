// Generated by CoffeeScript 1.10.0
(function() {
  var InformerJp2, InformerJp2Openjpeg, child_process,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  child_process = require('child_process');

  InformerJp2 = require('./informer-jp2').InformerJp2;

  InformerJp2Openjpeg = (function(superClass) {
    extend(InformerJp2Openjpeg, superClass);

    function InformerJp2Openjpeg(path, final_callback) {
      this.path = path;
      this.final_callback = final_callback;
      this.inform = bind(this.inform, this);
      this.info = null;
    }

    InformerJp2Openjpeg.prototype.inform = function() {
      var cmd;
      cmd = "opj_dump -i " + this.path;
      return child_process.exec(cmd, (function(_this) {
        return function(err, out, stderr) {
          var height, height_match, i, level, levels, levels_match, ref, scale_factors, sizes, tiles_height, tiles_match_height, tiles_match_width, tiles_width, width, width_match;
          width_match = out.match(/x1=(.*),/);
          width = parseInt(width_match[1]);
          height_match = out.match(/, y1=(.*)/);
          height = parseInt(height_match[1]);
          levels_match = out.match(/numresolutions=(.*)/);
          levels = parseInt(levels_match[1]) - 1;
          tiles_match_width = out.match(/tdx=(.*),/);
          tiles_width = parseInt(tiles_match_width[1]);
          tiles_match_height = out.match(/tdy=(.*)/);
          tiles_height = parseInt(tiles_match_height[1]);
          _this.info = {
            width: width,
            height: height,
            levels: levels,
            tiles: [
              {
                width: tiles_width,
                height: tiles_height
              }
            ]
          };
          sizes = _this.calculate_sizes_for_levels();
          scale_factors = [];
          for (level = i = 0, ref = _this.info.levels; 0 <= ref ? i <= ref : i >= ref; level = 0 <= ref ? ++i : --i) {
            scale_factors.push(Math.pow(2, level));
          }
          _this.info.tiles[0]['scaleFactors'] = scale_factors;
          return _this.final_callback(_this.info);
        };
      })(this));
    };

    return InformerJp2Openjpeg;

  })(InformerJp2);

  exports.InformerJp2Openjpeg = InformerJp2Openjpeg;

}).call(this);
